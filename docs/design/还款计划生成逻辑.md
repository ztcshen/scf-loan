# 供应链金融贷款核心设计压缩版

## 一、背景

构建供应链金融贷款核心模块：

-   允许提前部分还款
-   退货触发自动部分还款
-   贷款模块只负责账务
-   上游保证不会超额还款
-   还款顺序：先利息后本金
-   关注是否存在账务风险

------------------------------------------------------------------------

## 二、核心结论

在供应链金融场景：

-   必须使用 **余额驱动模型**
-   必须使用 **日计息**
-   计划只是预测
-   账务才是权威

不能使用固定分期驱动模型。

------------------------------------------------------------------------

## 三、推荐总体架构

### 1️⃣ 合同层（静态）

-   存合同利率、到期日
-   可生成初始预测计划（展示用）
-   永不修改（用于审计）

------------------------------------------------------------------------

### 2️⃣ 本金账务层（核心）

`t_principal_ledger`

-   放款：+金额
-   还本金：-金额
-   本金余额 = sum(流水)

------------------------------------------------------------------------

### 3️⃣ 利息计提层（核心）

`t_interest_accrual`

每日计提：

    当日利息 = 昨日终本金 × 日利率

------------------------------------------------------------------------

### 4️⃣ 还款分配层

`t_repayment`\
`t_repayment_allocate_detail`

-   repay_type: USER / TRADE_RETURN
-   分配顺序：罚息 → 利息 → 本金

------------------------------------------------------------------------

### 5️⃣ 试算引擎

-   先虚拟计提至当前
-   模拟分配
-   不落库

------------------------------------------------------------------------

## 四、供应链退货模型

场景：

借 1 万瓶药 → 产生融资\
退 50 盒 → 自动部分还款

处理流程：

退货事件 → 生成系统还款单 → 按规则分配

本质：

> 退货 = 自动部分还款

------------------------------------------------------------------------

## 五、利息模型必须余额驱动

不能提前锁定未来利息。

每日计提：

    当日利息 = 昨日终本金 × 日利率

部分还款后：

-   本金余额下降
-   次日利息自然下降
-   不需要重算历史

------------------------------------------------------------------------

## 六、先息后本的账务风险点

### 风险 1：计提时点

必须固定规则：

-   每日固定时间计提（如 00:00）
-   还款当天不重复计息
-   本金变动 T+1 生效

否则可能：

-   少计息
-   重复计息
-   对账不一致

------------------------------------------------------------------------

### 风险 2：利息吃本金

若还款金额小于未还利息：

-   全部冲利息
-   本金不变
-   次日继续按原本金计息

这是业务规则问题，不是系统错误。

------------------------------------------------------------------------

### 风险 3：负利息

必须保证：

    未还利息 = max(累计计提 - 已核销, 0)

不得出现负值。

------------------------------------------------------------------------

### 风险 4：试算与真实不一致

如果：

-   试算按实时计息
-   实际按日终计提

会产生偏差。

必须统一逻辑。

------------------------------------------------------------------------

## 七、关于还款计划

在供应链金融中：

-   合同计划 = 固定预测
-   展示计划 = 可重算
-   真实应还 = 账务计算结果

提前还款后：

-   重算未来预测计划
-   不修改历史账务

------------------------------------------------------------------------

## 八、贷款模块的最小安全原则

必须保证：

1.  本金余额可由流水反推
2.  利息来源可追溯（计提记录）
3.  还款分配有明细
4.  余额字段只是缓存，可校验

满足以上原则：

> 先息后本不会引发结构性账务风险

------------------------------------------------------------------------

## 九、最终模型总结

供应链金融贷款核心应为：

-   交易驱动本金变化
-   本金驱动利息生成
-   利息与本金分账核销
-   计划只是余额预测

------------------------------------------------------------------------

## 十、落地产出

### 1️⃣ 账务口径与不变量

-   本金余额 = 放款流水 - 本金还款流水
-   未还利息 = max(累计计提 - 已核销, 0)
-   还款分配顺序：罚息 → 利息 → 本金
-   计划不可改写历史账务

------------------------------------------------------------------------

### 2️⃣ 核心数据对象

-   合同信息：合同利率、到期日、初始预测计划
-   本金流水：放款、还本
-   利息计提：日计息记录
-   还款单：用户还款/退货还款
-   分配明细：罚息/利息/本金分账

------------------------------------------------------------------------

### 3️⃣ 核心流程输出

-   放款：入本金流水 + 初始化预测计划
-   日终计提：按日终本金计提利息
-   还款确认：生成还款单 + 按序分配
-   退货还款：事件触发系统还款单
-   试算：虚拟计提 + 模拟分配，不落库

------------------------------------------------------------------------

### 4️⃣ 验证与对账点

-   余额可由流水回放验证
-   计提来源可追溯
-   还款分配可回放
-   试算口径与真实口径一致
