# 还款服务核心接口文档

> **注意**：本文档描述的是内部领域服务接口（Internal Domain Service），而非直接对外的 API 接口。调用方（如业务层 Service）在使用前需负责准备完整的上下文参数（可能涉及多次数据库查询或配置读取）。

## 1. 还款计划生成接口

**接口定义**: `RepayPlanService#generatePlan`
**功能描述**: 根据放款金额、期限、利率及还款方式等参数，生成预期的分期还款计划表。
**调用场景**: 借款申请提交前试算、放款成功后生成正式还款计划。

### 请求参数 (`RepayPlanRequest`)

| 字段名 | 类型 | 必填 | 说明 | **数据来源建议** |
| :--- | :--- | :--- | :--- | :--- |
| `repayMethod` | `RepayMethod` | 是 | 还款方式 | 前端传入 / 借款申请表 |
| `principal` | `Long` | 是 | 放款本金 (分) | 前端传入 / 借款申请表 |
| `loanDate` | `LocalDate` | 是 | 放款日期 | 业务指定 / 系统当前日期 |
| `periodCount` | `Integer` | 是 | 总期数 | 前端传入 / 借款申请表 |
| `periodDays` | `Integer` | 是 | 每期天数 | 产品配置表 / 业务规则 |
| `dailyRate` | `Long` | 是 | 日利率 (1e-8) | 产品配置表 / 合同约定 |
| `penaltyDailyRate` | `Long` | 是 | 罚息日利率 (1e-8) | 产品配置表 / 合同约定 |
| `chargeRates` | `List<ChargeRate>` | 否 | 其他费用费率列表 (除本息罚外的其他科目) | 产品配置表 |
| `interestType` | `String` | 否 | 计息方式 | 产品配置表 (策略扩展字段) |
| `periodUnit` | `String` | 否 | 期单位 (天/月) | 产品配置表 (策略扩展字段) |
| `dayCountConvention` | `String` | 否 | 计息天数约定 | 产品配置表 (策略扩展字段) |
| `rateType` | `String` | 否 | 利率类型 | 产品配置表 (策略扩展字段) |
| `graceType` | `String` | 否 | 宽限规则 | 产品配置表 (策略扩展字段) |
| `settlementMode` | `String` | 否 | 结算方式 | 产品配置表 (策略扩展字段) |

#### 嵌套对象: `ChargeRate`
| 字段名 | 类型 | 说明 | 数据来源建议 |
| :--- | :--- | :--- | :--- |
| `subject` | `ChargeSubject` | 费用科目 | 产品配置 |
| `rateUnit` | `RateUnit` | 费率单位 | 产品配置 |
| `rateValue` | `Long` | 费率值 | 产品配置 |

### 返回结果 (`List<RepayPlanItem>`)
返回有序列表，每项代表一期计划。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `period` | `Integer` | 期次序号 |
| `startDate` | `LocalDate` | 本期起始日期 |
| `dueDate` | `LocalDate` | 本期到期日期 |
| `amountDetail` | `List<RepayPlanSubjectDetail>` | 本期各科目应还金额明细 |

#### 嵌套对象: `RepayPlanSubjectDetail`
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `subject` | `ChargeSubject` | 科目标识 (本金/利息等) |
| `amount` | `Long` | 本期该科目应还金额 (分) |

### JSON 示例

#### 请求示例
```json
{
  "repayMethod": "INTEREST_FIRST",
  "principal": 1000000,
  "dailyRate": 3000,
  "penaltyDailyRate": 5000,
  "loanDate": "2023-01-01",
  "periodDays": 30,
  "periodCount": 12,
  "chargeRates": [
    {
      "subject": "GUARANTEE_FEE",
      "rateUnit": "DAILY",
      "rateValue": 2000
    }
  ]
}
```

#### 返回示例
```json
[
  {
    "period": 1,
    "startDate": "2023-01-01",
    "dueDate": "2023-02-01",
    "amountDetail": [
      {
        "subject": "PRINCIPAL",
        "amount": 0
      },
      {
        "subject": "INTEREST",
        "amount": 900
      },
      {
        "subject": "GUARANTEE_FEE",
        "amount": 600
      }
    ]
  },
  {
    "period": 12,
    "startDate": "2023-12-01",
    "dueDate": "2024-01-01",
    "amountDetail": [
      {
        "subject": "PRINCIPAL",
        "amount": 1000000
      },
      {
        "subject": "INTEREST",
        "amount": 900
      },
      {
        "subject": "GUARANTEE_FEE",
        "amount": 600
      }
    ]
  }
]
```

---

## 2. 还款试算接口

**接口定义**: `RepayTrialService#trial`
**功能描述**: 基于原始还款计划和实际执行记录，计算当前时点的还款状态（应还、已还、未还、罚息等）。
**调用场景**: 用户发起主动还款前查询、每日跑批计算逾期罚息。

### 请求参数 (`RepayTrialRequest`)

> **特别说明**: 此对象通常无法直接从前端获取完整数据，需后端 Service 层组装。

| 字段名 | 类型 | 必填 | 说明 | **数据来源建议** |
| :--- | :--- | :--- | :--- | :--- |
| `trialDate` | `LocalDate` | 是 | 试算日期 | 当前日期 / 指定日期 |
| `planRequest` | `RepayPlanRequest` | 是 | 原始还款计划参数 | **查询 `t_loan_order` 或 `t_repay_plan` 主表反查组装** |
| `repayDates` | `List<LocalDate>` | 否 | 历史还款日期列表 (用于计算起息日，**假设利息已结清**) | **查询 `t_repay_record` (还款流水表) 获取成功还款的日期集合** |
| `periodDetails` | `List<RepayTrialScheduleItem>` | 否 | 各期实际执行情况 | **查询 `t_repay_plan_item` (还款计划明细表) 获取各期已还金额** |

#### 嵌套对象: `RepayTrialScheduleItem`
| 字段名 | 类型 | 说明 | 数据来源建议 |
| :--- | :--- | :--- | :--- |
| `period` | `Integer` | 期次序号 | 数据库 `t_repay_plan_item` |
| `startDate` | `LocalDate` | 本期起始日期 | 数据库 `t_repay_plan_item` |
| `dueDate` | `LocalDate` | 本期到期日期 | 数据库 `t_repay_plan_item` |
| `repaidDetails` | `List<RepayTrialSubjectAmount>` | 本期**已还**科目明细 | 数据库 `t_repay_plan_item` 的已还金额字段 |

#### 嵌套对象: `RepayTrialSubjectAmount`
| 字段名 | 类型 | 说明 | 数据来源建议 |
| :--- | :--- | :--- | :--- |
| `subject` | `ChargeSubject` | 科目标识 | 数据库 `t_repay_plan_item` |
| `amount` | `Long` | 金额 (分) | 数据库 `t_repay_plan_item` |

### 返回结果 (`RepayTrialResult`)
返回试算后的结果对象，包含当前状态下的详细还款明细。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `period` | `Integer` | 期次序号 |
| `startDate` | `LocalDate` | 本期起始日期 |
| `dueDate` | `LocalDate` | 本期到期日期 |
| `amountDetail` | `List<RepayTrialSubjectDetail>` | 各科目详细金额状态 (应还/已还/未还) |

#### 嵌套对象: `RepayTrialSubjectDetail`
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `subject` | `ChargeSubject` | 科目标识 |
| `dueAmount` | `Long` | 应还总金额 |
| `repaidAmount` | `Long` | 已还金额 |
| `unpaidAmount` | `Long` | 剩余未还金额 (`dueAmount - repaidAmount`) |

### JSON 示例

#### 请求示例
```json
{
  "trialDate": "2023-03-05",
  "planRequest": {
    "repayMethod": "INTEREST_FIRST",
    "principal": 1000000,
    "dailyRate": 3000,
    "penaltyDailyRate": 5000,
    "loanDate": "2023-01-01",
    "periodDays": 30,
    "periodCount": 12,
    "chargeRates": [
       { "subject": "GUARANTEE_FEE", "rateUnit": "DAILY", "rateValue": 2000 }
    ]
  },
  "repayDates": [
    "2023-02-01",
    "2023-03-01"
  ],
  "periodDetails": [
    {
      "period": 1,
      "startDate": "2023-01-01",
      "dueDate": "2023-02-01",
      "repaidDetails": [
        { "subject": "PRINCIPAL", "amount": 0 },
        { "subject": "INTEREST", "amount": 900 },
        { "subject": "GUARANTEE_FEE", "amount": 600 }
      ]
    },
    {
      "period": 2,
      "startDate": "2023-02-01",
      "dueDate": "2023-03-01",
      "repaidDetails": [
        { "subject": "PRINCIPAL", "amount": 0 },
        { "subject": "INTEREST", "amount": 500 }
      ]
    }
  ]
}
```

#### 返回示例
```json
{
  "period": 2,
  "startDate": "2023-02-01",
  "dueDate": "2023-03-01",
  "amountDetail": [
    {
      "subject": "PRINCIPAL",
      "dueAmount": 0,
      "repaidAmount": 0,
      "unpaidAmount": 0
    },
    {
      "subject": "INTEREST",
      "dueAmount": 900,
      "repaidAmount": 500,
      "unpaidAmount": 400
    },
    {
      "subject": "GUARANTEE_FEE",
      "dueAmount": 600,
      "repaidAmount": 0,
      "unpaidAmount": 600
    },
    {
      "subject": "PENALTY",
      "dueAmount": 10,
      "repaidAmount": 0,
      "unpaidAmount": 10
    }
  ]
}
```

---

## 附录：枚举定义

### 1. 还款方式 (`RepayMethod`)
*   `EQUAL_PRINCIPAL`: 等额本金
*   `EQUAL_PRINCIPAL_INTEREST`: 等额本息
*   `INTEREST_FIRST`: 先息后本

### 2. 费用科目 (`ChargeSubject`)
*   `PRINCIPAL`: 本金
*   `INTEREST`: 利息
*   `PENALTY`: 罚息
*   `GUARANTEE_FEE`: 担保费
*   `OTHER`: 其他费用

### 3. 费率单位 (`RateUnit`)
*   `DAILY`: 日利率
*   `MONTHLY`: 月利率
*   `YEARLY`: 年利率
