# 还款提醒设计方案

## 背景与目标
在已有还款试算、还款计划、还款接口的基础上，引入还款提醒能力，提升到期前通知覆盖率与逾期催收效率，同时避免对用户的过度打扰。

目标：
- 到期前、到期日、逾期后按规则触发提醒
- 支持按人聚合发送，降低短信成本与投诉风险
- 具备幂等、可追溯、可重试能力

## 业务范围
- 还款计划生成后的提醒任务创建
- 到期/逾期提醒触发与发送
- 发送结果记录与重试

不包含：
- 催收业务流程
- 还款确认结果回写

## 核心流程
1. 生成还款计划或账单时，计算提醒时间点并写入提醒任务
2. 定时调度扫描待发送任务
3. 按人/企业维度聚合任务，生成发送请求
4. 发送渠道执行并回写结果
5. 失败任务进入重试队列，超过阈值转失败终态

## 提醒策略
- 到期前提醒：T-7/T-3/T-1
- 到期日提醒：T
- 逾期提醒：T+1/T+3/T+7
- 自定义规则：支持配置化调整

## 聚合策略
默认按人聚合：
- 同一人、同一提醒类型、同一时间窗口合并为一条
- 展示前 N 笔金额最高/逾期最久账单，其余以“还有 N 笔未还”表达

可选按订单分组：
- 同一订单内多期账单合并

## 发送渠道
支持渠道：
- 短信
- 站内信
- 邮件/推送（可选）

发送优先级：
1. 用户偏好渠道
2. 默认渠道

## 幂等与去重
- 以“账单/期次 + 提醒类型 + 计划发送时间”为幂等维度
- 聚合发送时生成 aggregate_key 用于去重

## 数据模型建议（还款通知表）
字段建议：
- 基础标识：id、notify_no、biz_id
- 关联维度：customer_id、order_id、bill_id、period_no
- 提醒类型：notify_type
- 时间维度：due_date、overdue_days、trigger_time、plan_send_time、actual_send_time
- 金额维度：principal_amount、interest_amount、penalty_amount、total_amount
- 聚合维度：aggregate_key、aggregate_count、summary_json
- 渠道模板：channel、template_code、template_params
- 状态流转：status、retry_count、max_retry、next_retry_time
- 回执字段：provider_msg_id、provider_code、provider_message
- 审计字段：created_at、updated_at、created_by、updated_by
- 扩展字段：ext_json

## 状态流转
- 待发送 -> 发送中 -> 成功
- 待发送 -> 发送中 -> 失败 -> 重试中
- 重试超限 -> 失败终态

## 调度与性能
- 定时任务按时间窗口分批扫描
- 聚合逻辑先按人维度分组，再按优先级排序
- 发送接口支持批量

## 监控与告警
监控指标：
- 发送成功率
- 发送延迟
- 待发送积压量
- 重试比例

告警阈值：
- 成功率低于阈值
- 积压超过阈值

## 风险与待确认
待确认事项：
- 是否已有账单表或需新增账单模型
- 是否需要支持多租户/多产品
- 短信模板与法务合规要求
