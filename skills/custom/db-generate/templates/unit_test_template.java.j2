/**
 * Generated by skill: {{ generator_name }} v{{ generator_version }}
 * Since: {{ generated_at }}
 * Do not modify directly; regenerate via skills if changes are needed.
 * If manual changes are necessary, document @version, @since and change reasons in skill docs.
 */
package {{ package }};

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.scf.loan.common.base.dto.PageResult;
import {{ entity_package }}.{{ entity_name }};
import {{ mapper_package }}.{{ mapper_name }};
import {{ package|replace('.biz.service.impl','') }}.common.dto.{{ entity_name|replace('Entity','PageDTO') }};
import {{ package|replace('.biz.service.impl','') }}.common.dto.{{ entity_name|replace('Entity','DTO') }};
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Spy;
import org.mockito.junit.jupiter.MockitoExtension;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

/**
 * {{ service_name }}单元测试
 */
@ExtendWith(MockitoExtension.class)
public class {{ test_name }} {

    private static final Logger logger = LoggerFactory.getLogger({{ test_name }}.class);

    @InjectMocks
    @Spy
    private {{ service_impl_name }} {{ service_name[0]|lower }}{{ service_name[1:] }};

    @Mock
    private {{ mapper_name }} {{ mapper_name[0]|lower }}{{ mapper_name[1:] }};

    @BeforeEach
    public void setUp() {
        // MockitoAnnotations.openMocks(this); // Not needed with @ExtendWith(MockitoExtension.class)
    }

    /**
     * 测试批量创建{{ entity_name|replace('Entity', '') }}
     */
    @Test
    public void testBatchCreate{{ entity_name|replace('Entity', '') }}() {
        logger.info("开始执行测试批量创建{{ entity_name|replace('Entity', '') }}");
        
        List<{{ entity_name }}> entities = new ArrayList<>();
        {{ entity_name }} entity = new {{ entity_name }}();
        entity.setId(1L);
        entities.add(entity);

        // 模拟 saveBatch 返回 true
        doReturn(true).when({{ service_name[0]|lower }}{{ service_name[1:] }}).saveBatch(entities);

        boolean result = {{ service_name[0]|lower }}{{ service_name[1:] }}.batchCreate{{ entity_name|replace('Entity', '') }}(entities);
        assertTrue(result);
        
        verify({{ service_name[0]|lower }}{{ service_name[1:] }}, times(1)).saveBatch(entities);
        
        logger.info("测试批量创建{{ entity_name|replace('Entity', '') }}执行完成");
    }

    /**
     * 测试批量更新{{ entity_name|replace('Entity', '') }}
     */
    @Test
    public void testBatchUpdate{{ entity_name|replace('Entity', '') }}() {
        logger.info("开始执行测试批量更新{{ entity_name|replace('Entity', '') }}");
        
        List<{{ entity_name }}> entities = new ArrayList<>();
        {{ entity_name }} entity = new {{ entity_name }}();
        entity.setId(1L);
        entities.add(entity);

        // 模拟 updateBatchById 返回 true
        doReturn(true).when({{ service_name[0]|lower }}{{ service_name[1:] }}).updateBatchById(entities);

        boolean result = {{ service_name[0]|lower }}{{ service_name[1:] }}.batchUpdate{{ entity_name|replace('Entity', '') }}(entities);
        assertTrue(result);
        
        verify({{ service_name[0]|lower }}{{ service_name[1:] }}, times(1)).updateBatchById(entities);
        
        logger.info("测试批量更新{{ entity_name|replace('Entity', '') }}执行完成");
    }

    /**
     * 测试分页查询{{ entity_name|replace('Entity', '') }}
     */
    @Test
    @SuppressWarnings("unchecked")
    public void testPage{{ entity_name|replace('Entity', '') }}() {
        logger.info("开始执行测试分页查询{{ entity_name|replace('Entity', '') }}");

        {{ entity_name|replace('Entity','PageDTO') }} pageDTO = new {{ entity_name|replace('Entity','PageDTO') }}();
        pageDTO.setPage(1);
        pageDTO.setSize(10);
        pageDTO.setId(1L);
        pageDTO.setStartTime(LocalDateTime.now().minusDays(1));
        pageDTO.setEndTime(LocalDateTime.now());

        {{ entity_name }} entity = new {{ entity_name }}();
        entity.setId(1L);
        entity.setCreatedAt(LocalDateTime.now());
        
        Page<{{ entity_name }}> page = new Page<>();
        page.setRecords(Collections.singletonList(entity));
        page.setTotal(1);

        // 模拟 page 方法
        doReturn(page).when({{ service_name[0]|lower }}{{ service_name[1:] }}).page(any(Page.class), any(QueryWrapper.class));

        PageResult<{{ entity_name|replace('Entity','DTO') }}> result = {{ service_name[0]|lower }}{{ service_name[1:] }}.page{{ entity_name|replace('Entity', '') }}(pageDTO);
        
        assertNotNull(result);
        assertEquals(1, result.getTotal());
        assertEquals(1, result.getRecords().size());
        assertEquals(1L, result.getRecords().get(0).getId());

        verify({{ service_name[0]|lower }}{{ service_name[1:] }}, times(1)).page(any(Page.class), any(QueryWrapper.class));

        logger.info("测试分页查询{{ entity_name|replace('Entity', '') }}执行完成");
    }

    /**
     * 测试分页查询{{ entity_name|replace('Entity', '') }} - 空条件
     */
    @Test
    @SuppressWarnings("unchecked")
    public void testPage{{ entity_name|replace('Entity', '') }}WithEmptyConditions() {
        logger.info("开始执行测试分页查询{{ entity_name|replace('Entity', '') }} - 空条件");

        {{ entity_name|replace('Entity','PageDTO') }} pageDTO = new {{ entity_name|replace('Entity','PageDTO') }}();
        pageDTO.setPage(1);
        pageDTO.setSize(10);
        // 不设置任何查询条件

        {{ entity_name }} entity = new {{ entity_name }}();
        entity.setId(1L);
        entity.setCreatedAt(LocalDateTime.now());
        
        Page<{{ entity_name }}> page = new Page<>();
        page.setRecords(Collections.singletonList(entity));
        page.setTotal(1);

        // 模拟 page 方法
        doReturn(page).when({{ service_name[0]|lower }}{{ service_name[1:] }}).page(any(Page.class), any(QueryWrapper.class));

        PageResult<{{ entity_name|replace('Entity','DTO') }}> result = {{ service_name[0]|lower }}{{ service_name[1:] }}.page{{ entity_name|replace('Entity', '') }}(pageDTO);
        
        assertNotNull(result);
        assertEquals(1, result.getTotal());
        assertEquals(1, result.getRecords().size());

        verify({{ service_name[0]|lower }}{{ service_name[1:] }}, times(1)).page(any(Page.class), any(QueryWrapper.class));

        logger.info("测试分页查询{{ entity_name|replace('Entity', '') }} - 空条件 执行完成");
    }
}
